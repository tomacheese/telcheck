# CLAUDE.md

## 目的
Claude Code の作業方針とプロジェクト固有ルールを示す。

## 判断記録のルール
1. 判断内容の要約を記載する
2. 検討した代替案を列挙する
3. 採用しなかった案とその理由を明記する
4. 前提条件・仮定・不確実性を明示する
5. 他エージェントによるレビュー可否を示す

## プロジェクト概要
- 目的: Yamaha NVR510 ルーターの発信者確認と通知
- 主な機能:
  - システムログの解析による発着信情報の取得
  - 電話番号の所有者検索（迷惑電話の特定）
  - 各種プラットフォーム（Discord, Slack, LINE, Web Push）への通知

## 重要ルール
- 会話言語: 日本語
- コメント言語: 日本語
- エラーメッセージ言語: 英語
- PR / コミットメッセージ: Conventional Commits (日本語 description)
- 日本語と英数字の間には半角スペースを挿入する。

## 環境のルール
- ブランチ命名: Conventional Branch (feat, fix)
- GitHub リポジトリ調査方法: 必要に応じてテンポラリディレクトリに clone して検索する
- Renovate PR: 追加コミットや更新を行わない

## コード改修時のルール
- エラーメッセージの絵文字統一: 既存のメッセージに絵文字がある場合は、内容に即した絵文字を先頭に付与する。
- TypeScript: `skipLibCheck` の使用を禁止する。
- docstring: 関数やインターフェースには JSDoc 等を日本語で記載する。

## 相談ルール
- Codex CLI: 実装レビュー、局所設計、整合性確認
- Gemini CLI: 外部仕様、最新情報確認
- 指摘への対応: 信頼度スコア 50 以上の指摘には必ず対応する（黙殺禁止）。

## 開発コマンド
```bash
# インストール
pnpm install

# 開発
pnpm dev

# Lint / 型チェック
pnpm lint

# 自動修正
pnpm fix

# Schema 生成
pnpm generate-schema
```

## アーキテクチャと主要ファイル
- `src/main.ts`: エントリーポイント
- `src/utils/nvr510.ts`: NVR510 ログ解析ロジック
- `src/utils/search-number.ts`: 電話番号検索ロジック
- `src/utils/destination.ts`: 通知処理の振り分け
- `src/web/`: Fastify による Web サーバー・API 実装
- `src/public/`: ダッシュボードのフロントエンド資産

## 実装パターン
- 推奨: 型安全なコーディング、`src/utils` へのロジック分離。
- 非推奨: 共通ロジックの `src/web` への直接記述。

## テスト
- テスト方針: 現状は Lint と型チェックによる検証。
- 追加テスト: 必要に応じて Vitest 等の導入を検討する。

## ドキュメント更新ルール
- 設定変更時: `schema/Configuration.json` を `pnpm generate-schema` で更新する。
- API 変更時: `API.md` を更新する。

## 作業チェックリスト

### 新規改修時
1. プロジェクトを理解する
2. 作業ブランチが適切であることを確認する
3. 最新のリモートブランチに基づいた新規ブランチであることを確認する
4. 不要ブランチが削除済みであることを確認する
5. pnpm で依存関係をインストールする

### コミット・プッシュ前
1. Conventional Commits に従っていることを確認する
2. センシティブな情報が含まれていないことを確認する
3. Lint / Format エラーがないことを確認する
4. 動作確認を行う

### PR 作成前
1. PR 作成の依頼があることを確認する
2. センシティブな情報が含まれていないことを確認する
3. コンフリクトの恐れがないことを確認する

### PR 作成後
1. コンフリクトがないことを確認する
2. PR 本文が最新状態のみを網羅していることを確認する
3. `gh pr checks` で CI を確認する
4. Copilot レビューに対応する
5. Codex のコードレビューを実施する

## リポジトリ固有
- NVR510 のログイン・ログ取得処理はルーターへの負荷を考慮して実装されている。
- Web Push 通知には VAPID キーの設定が必要。
